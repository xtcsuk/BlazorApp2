@using AntDesign
@using BlazorApp2.Models;
@using System.Text.Json;

@if (Data == null)
{
    return;
}

@*  
    As a default behavior (AntDesign Select component), the OnSelectedItemChanged callback can only get the value of the 
    selected item. The "LabelInValue" property can be used to get the label property of the selected item.
    The label of the selected item will be packed as an string (JSON) for passing to the OnSelectedItemChanged callback. 
    This function is only available when the SelectOptions are created without a DataStore.
*@

@*@(item => OnSelectedItemChanged(ConvertToSelectModel(item)))*@
<Select DefaultValue="@CurrentValue"
        Id="antdSelect"
        DropdownMatchSelectWidth="true"
        TItem="string"
        TItemValue="string"
        LabelInValue="false"
        @bind-Value="@_currentValue"
        OnSelectedItemChanged="ItemClicked" Disabled="@Disabled">

    <SelectOptions>
        @foreach (var item in Data)
        {
            if (item.Divider)
            {
                <Divider />
            }
            else
            {
                <SelectOption Class="@OptionCssClass"
                      TItemValue="string"
                      TItem="string"
                      Value="@item.Id"
                      Label="@item.Description"
                      Disabled=@item.Disabled
                >
                </SelectOption>
            }
        }
    </SelectOptions>
</Select>

@code {
    private string _currentValue = string.Empty;

    [Parameter]
    public IEnumerable<SelectModel> Data { get; set; } = new List<SelectModel>();

    [Parameter]
    public string LabelCaption { get; set; } = string.Empty;

    [Parameter]
    public string CurrentValue { get; set; } = string.Empty;

    [Parameter]
    public bool Disabled { get; set; } = false;

    [Parameter]
    public string OptionCssClass { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<SelectModel> OnItemClick { get; set; }

    protected override void OnInitialized()
    {
        //_currentValue = CurrentValue;
    }
    //private SelectModel ConvertToSelectModel(string jsonString)
    //{
    //    var value = jsonString.Replace("value", "Id").Replace("label", "Name");
    //    var result = JsonSerializer.Deserialize<SelectModel>(value);
    //    return result ?? new SelectModel();
    //}

    private void ItemClicked(string value)
    {
        if (value != null && !CurrentValue.Equals(value))
        {
            _currentValue = value;
            var selectedModel = Data.Single(m => m.Id.Equals(value));
            var returnModel = new SelectModel
                {
                    Id = selectedModel.Id,
                    Disabled = selectedModel.Disabled,
                    Description = selectedModel.Description,
                    Divider = selectedModel.Divider
                };
            if (OnItemClick.HasDelegate)
            {
                OnItemClick.InvokeAsync(returnModel);
            }
        }
    }

    protected override void OnParametersSet()
    {
        _currentValue = CurrentValue;
        base.OnParametersSet();
    }
    //private void OnSelectedItemChanged(SelectModel value)
    //{
    //    if (!CurrentValue.Equals(value.Id))
    //    {
    //        CurrentValue = value.Id;
    //        if (OnSelectedItem.HasDelegate)
    //        {
    //            OnSelectedItem.InvokeAsync(value);
    //        }
    //    }
    //}
}    